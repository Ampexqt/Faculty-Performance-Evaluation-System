const express = require('express');
const router = express.Router();
const { promisePool } = require('../../config/db');

/**
 * GET /api/vpaa/deans
 * Get all Deans for VPAA to evaluate
 */
router.get('/deans', async (req, res) => {
    try {
        const [deans] = await promisePool.query(`
            SELECT 
                f.id,
                CONCAT(f.first_name, ' ', f.last_name) as full_name,
                f.email,
                f.sex,
                f.position,
                c.college_name,
                f.college_id
            FROM faculty f
            LEFT JOIN colleges c ON f.college_id = c.id
            WHERE f.position LIKE '%Dean%' AND f.status = 'active'
            ORDER BY f.first_name ASC
        `);

        res.json({
            success: true,
            data: deans
        });
    } catch (error) {
        console.error('Error fetching deans:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching deans',
            error: error.message
        });
    }
});

/**
 * POST /api/vpaa/generate-code
 * Generate evaluation code for a dean
 */
router.post('/generate-code', async (req, res) => {
    try {
        const { vpaa_id, dean_id, academic_year_id, semester } = req.body;

        if (!vpaa_id || !dean_id || !academic_year_id || !semester) {
            return res.status(400).json({
                success: false,
                message: 'All fields are required'
            });
        }

        // Generate random 6-character code
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();

        // Check if code already exists for this dean in this period
        const [existing] = await promisePool.query(
            `SELECT id FROM vpaa_evaluation_codes 
             WHERE vpaa_id = ? AND dean_id = ? AND academic_year_id = ? AND semester = ?`,
            [vpaa_id, dean_id, academic_year_id, semester]
        );

        if (existing.length > 0) {
            return res.status(400).json({
                success: false,
                message: 'Evaluation code already exists for this dean in this period'
            });
        }

        // Insert new code
        const [result] = await promisePool.query(
            `INSERT INTO vpaa_evaluation_codes 
             (vpaa_id, dean_id, code, academic_year_id, semester, status)
             VALUES (?, ?, ?, ?, ?, 'active')`,
            [vpaa_id, dean_id, code, academic_year_id, semester]
        );

        res.status(201).json({
            success: true,
            message: 'Evaluation code generated successfully',
            data: {
                id: result.insertId,
                code: code
            }
        });
    } catch (error) {
        console.error('Error generating code:', error);
        res.status(500).json({
            success: false,
            message: 'Error generating code',
            error: error.message
        });
    }
});

/**
 * GET /api/vpaa/codes/:vpaaId
 * Get all evaluation codes generated by VPAA
 */
router.get('/codes/:vpaaId', async (req, res) => {
    try {
        const { vpaaId } = req.params;

        const [codes] = await promisePool.query(`
            SELECT 
                vec.*,
                CONCAT(f.first_name, ' ', f.last_name) as dean_name,
                f.email as dean_email,
                c.college_name
            FROM vpaa_evaluation_codes vec
            LEFT JOIN faculty f ON vec.dean_id = f.id
            LEFT JOIN colleges c ON f.college_id = c.id
            WHERE vec.vpaa_id = ?
            ORDER BY vec.created_at DESC
        `, [vpaaId]);

        res.json({
            success: true,
            data: codes
        });
    } catch (error) {
        console.error('Error fetching codes:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching codes',
            error: error.message
        });
    }
});

/**
 * POST /api/vpaa/join-evaluation
 * VPAA joins evaluation using code
 */
router.post('/join-evaluation', async (req, res) => {
    try {
        const { vpaa_id, code } = req.body;

        if (!vpaa_id || !code) {
            return res.status(400).json({
                success: false,
                message: 'VPAA ID and code are required'
            });
        }

        // Find the code
        const [codeData] = await promisePool.query(
            `SELECT * FROM vpaa_evaluation_codes WHERE code = ? AND status = 'active'`,
            [code]
        );

        if (codeData.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Invalid or expired evaluation code'
            });
        }

        const evalCode = codeData[0];

        // Check if VPAA already joined this evaluation
        const [existing] = await promisePool.query(
            `SELECT id FROM vpaa_evaluations 
             WHERE vpaa_id = ? AND code_id = ?`,
            [vpaa_id, evalCode.id]
        );

        if (existing.length > 0) {
            return res.status(400).json({
                success: false,
                message: 'You have already joined this evaluation'
            });
        }

        // Create evaluation record
        await promisePool.query(
            `INSERT INTO vpaa_evaluations 
             (vpaa_id, dean_id, code_id, academic_year_id, semester, status)
             VALUES (?, ?, ?, ?, ?, 'pending')`,
            [vpaa_id, evalCode.dean_id, evalCode.id, evalCode.academic_year_id, evalCode.semester]
        );

        // Mark code as used
        await promisePool.query(
            `UPDATE vpaa_evaluation_codes SET status = 'used' WHERE id = ?`,
            [evalCode.id]
        );

        res.json({
            success: true,
            message: 'Successfully joined evaluation'
        });
    } catch (error) {
        console.error('Error joining evaluation:', error);
        res.status(500).json({
            success: false,
            message: 'Error joining evaluation',
            error: error.message
        });
    }
});

/**
 * GET /api/vpaa/my-evaluations/:vpaaId
 * Get all evaluations for VPAA
 */
router.get('/my-evaluations/:vpaaId', async (req, res) => {
    try {
        const { vpaaId } = req.params;

        const [evaluations] = await promisePool.query(`
            SELECT 
                ve.*,
                CONCAT(f.first_name, ' ', f.last_name) as dean_name,
                f.email as dean_email,
                c.college_name
            FROM vpaa_evaluations ve
            LEFT JOIN faculty f ON ve.dean_id = f.id
            LEFT JOIN colleges c ON f.college_id = c.id
            WHERE ve.vpaa_id = ?
            ORDER BY ve.created_at DESC
        `, [vpaaId]);

        res.json({
            success: true,
            data: evaluations
        });
    } catch (error) {
        console.error('Error fetching evaluations:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching evaluations',
            error: error.message
        });
    }
});

/**
 * POST /api/vpaa/submit-evaluation
 * Submit evaluation for a dean
 */
router.post('/submit-evaluation', async (req, res) => {
    try {
        const { evaluation_id, rating, comments } = req.body;

        if (!evaluation_id) {
            return res.status(400).json({
                success: false,
                message: 'Evaluation ID is required'
            });
        }

        await promisePool.query(
            `UPDATE vpaa_evaluations 
             SET rating = ?, comments = ?, status = 'completed', evaluated_at = NOW()
             WHERE id = ?`,
            [rating, comments, evaluation_id]
        );

        res.json({
            success: true,
            message: 'Evaluation submitted successfully'
        });
    } catch (error) {
        console.error('Error submitting evaluation:', error);
        res.status(500).json({
            success: false,
            message: 'Error submitting evaluation',
            error: error.message
        });
    }
});

module.exports = router;
